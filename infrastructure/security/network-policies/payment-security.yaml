apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: payment-service-network-policy
  namespace: getit-development
  labels:
    component: security
    service: payment
    bangladesh: enabled
spec:
  podSelector:
    matchLabels:
      app: payment-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    - podSelector:
        matchLabels:
          app: order-service
    - podSelector:
        matchLabels:
          app: user-service
    ports:
    - protocol: TCP
      port: 3003
  egress:
  # Allow access to database
  - to: []
    ports:
    - protocol: TCP
      port: 5432
  # Allow access to Bangladesh payment gateways
  - to: []
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 80
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: shipping-service-network-policy
  namespace: getit-development
  labels:
    component: security
    service: shipping
    bangladesh: enabled
spec:
  podSelector:
    matchLabels:
      app: shipping-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    - podSelector:
        matchLabels:
          app: order-service
    ports:
    - protocol: TCP
      port: 3013
  egress:
  # Allow access to database
  - to: []
    ports:
    - protocol: TCP
      port: 5432
  # Allow access to Bangladesh courier APIs
  - to: []
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 80
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: database-access-policy
  namespace: getit-development
  labels:
    component: security
    tier: database
spec:
  podSelector:
    matchLabels:
      tier: database
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          tier: microservice
    ports:
    - protocol: TCP
      port: 5432
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: monitoring-network-policy
  namespace: getit-monitoring
  labels:
    component: security
    tier: monitoring
spec:
  podSelector:
    matchLabels:
      tier: monitoring
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: getit-development
    - namespaceSelector:
        matchLabels:
          name: getit-production
    ports:
    - protocol: TCP
      port: 9090
    - protocol: TCP
      port: 3000
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: getit-development
    - namespaceSelector:
        matchLabels:
          name: getit-production
    ports:
    - protocol: TCP
      port: 3001
    - protocol: TCP
      port: 3002
    - protocol: TCP
      port: 3003
    - protocol: TCP
      port: 3004
    - protocol: TCP
      port: 3013
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53